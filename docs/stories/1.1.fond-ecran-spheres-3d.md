# Story 1.1: Fond d'écran - Sphères 3D Three.js

## Status
Draft

## Story

**As a** utilisateur du portfolio,  
**I want** un fond d'écran animé avec des sphères 3D qui chutent et réagissent à ma souris,  
**so that** le portfolio ait un aspect visuel moderne et interactif qui reflète mes compétences techniques.

## Contexte et objectif

### Contexte
Le portfolio OS nécessite un fond d'écran dynamique pour améliorer l'expérience visuelle. Cette story implémente le premier type de fond d'écran : des sphères 3D animées utilisant Three.js.

### Objectif
Créer un système de fond d'écran avec des sphères 3D qui :
- Chutent du haut de l'écran au démarrage
- S'empilent naturellement avec physique
- Réagissent au passage de la souris (interaction)
- S'intègrent de manière transparente derrière le Desktop

### Relation au lot
Cette story fait partie du **Lot 1 : Système de fond d'écran** et constitue la base du système. Les stories suivantes (1.2 ShaderGradient, 1.3 Settings) dépendent de cette implémentation.

## Scope précis

### In Scope ✅
- Installation et configuration de Three.js + @react-three/fiber + @react-three/drei
- Création du composant `WallpaperSpheres` avec physique de chute
- Intégration dans le Desktop (derrière tous les éléments)
- Détection WebGL et fallback CSS si non supporté
- Gestion d'erreurs avec ErrorBoundary (si M7 déjà fait, sinon fallback basique)
- Configuration initiale : 20 sphères, gravity 0.5, interaction souris activée
- Performance : 60fps cible, optimisation pour éviter lag

### Out of Scope ❌
- Interface Settings pour changer de fond (Story 1.3)
- Autres types de fonds (ShaderGradient = Story 1.2)
- Persistance préférence utilisateur (Story 1.3)
- Configuration avancée (nombre sphères, couleurs) - hardcodé pour MVP

## Acceptance Criteria

1. **AC1 - Installation dépendances**
   - Three.js, @react-three/fiber, @react-three/drei installés et fonctionnels
   - Pas d'erreurs de build ou runtime liées aux dépendances

2. **AC2 - Affichage sphères 3D**
   - Les sphères 3D s'affichent correctement derrière le Desktop
   - 20 sphères visibles au démarrage
   - Les sphères chutent du haut vers le bas avec physique réaliste

3. **AC3 - Interaction souris**
   - Les sphères réagissent au passage de la souris (déplacement/attraction)
   - L'interaction est fluide sans lag perceptible

4. **AC4 - Détection WebGL**
   - Le système détecte si WebGL est supporté
   - Si WebGL non supporté : fallback vers fond CSS dégradé simple
   - Pas de crash ou erreur visible pour l'utilisateur

5. **AC5 - Performance**
   - Animation fluide à 60fps (ou proche)
   - Pas de lag lors du déplacement de fenêtres/icônes
   - Bundle size acceptable (Three.js optimisé avec code splitting)

6. **AC6 - Intégration Desktop**
   - Le fond s'affiche derrière tous les éléments (Desktop, icônes, fenêtres, taskbar)
   - Pas d'interférence avec les interactions utilisateur (drag, clic)
   - Z-index correct : fond < Desktop < éléments interactifs

## Impacts

### Fichiers/Modules à créer

**Nouveaux fichiers:**
- `src/components/Wallpaper/WallpaperProvider.jsx` - Provider contextuel pour état wallpaper global
- `src/components/Wallpaper/WallpaperProvider.module.css` - Styles du provider
- `src/components/Wallpaper/WallpaperSpheres.jsx` - Composant sphères 3D avec Three.js
- `src/components/Wallpaper/WallpaperSpheres.module.css` - Styles (minimal, Three.js gère le rendu)
- `src/constants/wallpaper.js` - Constantes types et configurations wallpaper

**Fichiers à modifier:**
- `src/components/Desktop/Desktop.jsx` - Intégrer WallpaperProvider et WallpaperSpheres
- `src/components/Desktop/Desktop.module.css` - Ajuster z-index pour fond
- `package.json` - Ajouter dépendances Three.js
- `vite.config.js` - Configurer code splitting pour Three.js (manual chunks)

### Endpoints
**Aucun** - Système 100% frontend, pas d'API externe

### Base de données
**Aucune** - Pas de persistance pour cette story (localStorage dans Story 1.3)

### Dépendances npm à installer
```bash
npm install three @react-three/fiber @react-three/drei
```

## Tasks / Subtasks

- [ ] **Task 1: Installation et configuration dépendances** (AC: 1)
  - [ ] Installer `three`, `@react-three/fiber`, `@react-three/drei`
  - [ ] Vérifier compatibilité avec React 19.2.0
  - [ ] Configurer Vite pour code splitting Three.js (manual chunks dans vite.config.js)
  - [ ] Tester build production sans erreurs

- [ ] **Task 2: Création constants wallpaper** (AC: 2)
  - [ ] Créer `src/constants/wallpaper.js`
  - [ ] Définir `WALLPAPER_TYPES` avec `SPHERES_3D: 'spheres-3d'`
  - [ ] Exporter configuration par défaut (sphereCount: 20, gravity: 0.5, mouseInteraction: true)

- [ ] **Task 3: Composant WallpaperProvider** (AC: 2, 6)
  - [ ] Créer `src/components/Wallpaper/WallpaperProvider.jsx`
  - [ ] Implémenter Context React pour état wallpaper global
  - [ ] Gérer état : `currentWallpaper`, `wallpaperConfig`
  - [ ] Détection WebGL support (fonction `detectWebGL()`)
  - [ ] Gérer état loading pendant initialisation Three.js
  - [ ] Créer styles CSS module (positionnement, z-index)

- [ ] **Task 4: Composant WallpaperSpheres** (AC: 2, 3, 5)
  - [ ] Créer `src/components/Wallpaper/WallpaperSpheres.jsx`
  - [ ] Utiliser `@react-three/fiber` Canvas pour rendu 3D
  - [ ] Créer 20 sphères avec Three.js (Mesh, SphereGeometry, MeshStandardMaterial)
  - [ ] Implémenter physique de chute (gravity, velocity)
  - [ ] Ajouter interaction souris (raycasting, attraction sphères vers curseur)
  - [ ] Optimiser performance (useFrame avec throttling si nécessaire)
  - [ ] Gérer cleanup (dispose geometries/materials)

- [ ] **Task 5: Intégration Desktop** (AC: 4, 6)
  - [ ] Modifier `src/components/Desktop/Desktop.jsx`
  - [ ] Envelopper Desktop avec WallpaperProvider
  - [ ] Ajouter WallpaperSpheres conditionnel (si WebGL supporté)
  - [ ] Ajuster z-index dans Desktop.module.css (fond: z-index: 0, Desktop: z-index: 1)
  - [ ] Tester que fond n'interfère pas avec drag/clic

- [ ] **Task 6: Fallback WebGL** (AC: 4)
  - [ ] Si WebGL non supporté : afficher fond CSS dégradé simple
  - [ ] Créer composant `WallpaperFallback.jsx` (fond CSS)
  - [ ] Intégrer dans WallpaperProvider (condition WebGL)
  - [ ] Tester sur navigateur sans WebGL (ou DevTools → désactiver WebGL)

- [ ] **Task 7: Tests unitaires** (AC: 2, 3, 4)
  - [ ] Test détection WebGL (mock navigator)
  - [ ] Test WallpaperProvider context (valeur par défaut)
  - [ ] Test fallback si WebGL non supporté
  - [ ] Note: Tests Three.js Canvas nécessitent setup spécial (peut être reporté si infrastructure tests pas prête)

## Dev Notes

### Architecture technique

**Source: design-solution-par-lot.md#Lot-1**

#### Modèle de données
```javascript
// État wallpaper (dans WallpaperProvider Context)
{
  currentWallpaper: 'spheres-3d',
  wallpaperConfig: {
    'spheres-3d': {
      sphereCount: 20,
      gravity: 0.5,
      mouseInteraction: true,
    }
  },
  webglSupported: boolean,
  isLoading: boolean,
}
```

#### Structure composants
- **WallpaperProvider**: Context provider, gestion état global, détection WebGL
- **WallpaperSpheres**: Composant Three.js avec Canvas, physique, interaction
- **WallpaperFallback**: Composant CSS simple (fond dégradé) si WebGL non supporté

#### Intégration Desktop
Le fond doit être rendu **derrière** le Desktop mais **dans le même arbre React** pour bénéficier du Context. Structure suggérée :

```jsx
<WallpaperProvider>
  <WallpaperSpheres /> {/* ou WallpaperFallback */}
  <Desktop>
    {/* icônes, fenêtres, taskbar */}
  </Desktop>
</WallpaperProvider>
```

#### Détection WebGL
```javascript
function detectWebGL() {
  try {
    const canvas = document.createElement('canvas');
    return !!(window.WebGLRenderingContext && 
              (canvas.getContext('webgl') || canvas.getContext('experimental-webgl')));
  } catch (e) {
    return false;
  }
}
```

#### Performance Three.js
- Utiliser `useFrame` avec throttling si nécessaire (60fps = 16.67ms par frame)
- Disposer geometries/materials dans cleanup useEffect
- Limiter nombre de sphères si performance dégradée (20 = cible)
- Code splitting Vite : séparer Three.js du bundle principal

#### Code splitting Vite
```javascript
// vite.config.js
export default {
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          'three': ['three', '@react-three/fiber', '@react-three/drei'],
        }
      }
    }
  }
}
```

### Source Tree

**Source: etat-des-lieux.md#Structure-fichiers**

Structure actuelle :
```
src/
├── components/
│   ├── Desktop/
│   ├── Window/
│   ├── DesktopIcon/
│   └── Taskbar/
└── apps/
```

Nouvelle structure après cette story :
```
src/
├── components/
│   ├── Desktop/
│   ├── Window/
│   ├── DesktopIcon/
│   ├── Taskbar/
│   └── Wallpaper/          # NOUVEAU
│       ├── WallpaperProvider.jsx
│       ├── WallpaperSpheres.jsx
│       └── WallpaperFallback.jsx
├── constants/              # NOUVEAU
│   └── wallpaper.js
└── apps/
```

### Patterns existants

**Source: etat-des-lieux.md#Patterns-existants**

- **CSS Modules**: Utiliser `.module.css` pour chaque composant (comme Desktop, Window)
- **State Management**: Context API pour état wallpaper (nouveau pattern, mais cohérent avec architecture React)
- **Composition**: Composants dans `components/`, pas de logique métier dans UI

### Contraintes techniques

**Source: etat-des-lieux.md#Contraintes-techniques**

- **React 19.2.0**: Vérifier compatibilité @react-three/fiber avec React 19
- **Pas de polyfills**: Cible navigateurs modernes (WebGL requis)
- **CSS Modules**: Scoping automatique, pas d'injection globale

### Gestion d'erreurs

**Source: design-solution-par-lot.md#Lot-1-Gestion-erreurs**

- **WebGL Detection**: Vérifier support avant initialisation Three.js
- **ErrorBoundary**: Si Story 3.1 (M7) déjà faite, utiliser ErrorBoundary global. Sinon, try/catch local dans WallpaperProvider
- **Fallback Strategy**: En cas d'erreur → fond CSS dégradé simple
- **Loading Timeout**: Si Three.js ne charge pas en < 3s → fallback

### Testing

**Source: design-solution-par-lot.md#Testing-Strategy**

#### Tests unitaires (priorité)
- Détection WebGL (mock navigator)
- WallpaperProvider context (valeurs par défaut)
- Fallback affichage si WebGL non supporté

#### Tests d'intégration (si infrastructure prête)
- Intégration Desktop + Wallpaper (z-index correct)
- Performance (fps check, pas de lag)

#### Tests E2E (optionnel, si infrastructure prête)
- Affichage sphères au chargement
- Interaction souris fonctionnelle

**Note**: Tests Three.js Canvas nécessitent setup spécial (jest-canvas-mock ou équivalent). Peut être reporté si infrastructure tests pas encore créée (Story 3.x).

### Risques identifiés

**Source: backlog-finalisation.md#Risques-techniques**

1. **Three.js bundle size** (Impact: Élevé, Probabilité: Moyenne)
   - **Mitigation**: Code splitting Vite (manual chunks)
   - **Rollback**: Désactiver Three.js, utiliser fallback CSS

2. **Performance dégradée** (Impact: Moyen, Probabilité: Faible)
   - **Mitigation**: Optimisation useFrame, limiter sphères, lazy loading
   - **Rollback**: Réduire nombre sphères à 10, désactiver interaction souris

3. **Compatibilité React 19** (Impact: Moyen, Probabilité: Faible)
   - **Mitigation**: Vérifier versions compatibles avant installation
   - **Rollback**: Downgrade React si nécessaire (non recommandé)

4. **WebGL non supporté** (Impact: Faible, Probabilité: Faible)
   - **Mitigation**: Détection + fallback CSS
   - **Rollback**: Fallback toujours disponible

### Plan de migration

**Aucune migration de données** - Cette story crée un nouveau système, pas de migration nécessaire.

### Plan de rollback

Si problèmes critiques après déploiement :

1. **Rollback immédiat**: Désactiver WallpaperProvider dans Desktop.jsx (commenter)
2. **Rollback partiel**: Utiliser uniquement WallpaperFallback (fond CSS)
3. **Rollback complet**: Supprimer dépendances Three.js, restaurer Desktop.jsx original

**Fichiers à restaurer en cas de rollback:**
- `src/components/Desktop/Desktop.jsx` (version sans WallpaperProvider)
- `package.json` (supprimer dépendances Three.js)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Story créée initialement | Bob (SM) |

## Dev Agent Record

*Cette section sera remplie par l'agent Dev lors de l'implémentation*

### Agent Model Used
_TBD_

### Debug Log References
_TBD_

### Completion Notes List
_TBD_

### File List
_TBD_

## QA Results

*Cette section sera remplie par l'agent QA lors de la revue*
