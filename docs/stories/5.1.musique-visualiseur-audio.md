# Story 5.1: Musique d'ambiance + Visualiseur sonore

## Status
Draft

## Story

**As a** visiteur du portfolio,  
**I want** pouvoir activer une musique d'ambiance avec visualiseur audio dans la taskbar,  
**so that** l'expérience soit immersive et démontre mes compétences en Web Audio API.

## Contexte et objectif

### Contexte
Cette story ajoute un système audio avec visualiseur (barres animées) dans la taskbar, créant une ambiance sonore pour le portfolio.

### Objectif
Implémenter un lecteur audio avec visualiseur utilisant Web Audio API, intégré dans la taskbar.

### Relation au lot
Cette story fait partie du **Lot 5 : Audio & UX** et est une fonctionnalité standalone.

## Scope précis

### In Scope ✅
- Service AudioService (gestion AudioContext, AnalyserNode)
- Composant AudioPlayer dans Taskbar (play/pause, volume)
- Composant AudioVisualizer (barres animées 8-16 barres)
- Chargement fichier audio (format MP3/OGG)
- Visualisation fréquences (60fps)
- Gestion autoplay policy (pas d'autoplay, bouton play manuel)

### Out of Scope ❌
- Sélection multiple pistes (une seule piste pour MVP)
- Contrôles avancés (seek, loop) - juste play/pause/volume
- Visualisations alternatives (waveform, spectrogramme)

## Acceptance Criteria

1. **AC1 - Service AudioService**
   - Service `audioService.js` créé
   - Gestion AudioContext, AnalyserNode
   - Lecture fichier audio (MP3/OGG)
   - Gestion état : isPlaying, volume, currentTrack

2. **AC2 - Composant AudioPlayer**
   - Composant dans Taskbar créé
   - Boutons play/pause fonctionnels
   - Contrôle volume (slider ou boutons)
   - Indication état (playing/paused)

3. **AC3 - Composant AudioVisualizer**
   - Composant barres audio animées créé
   - 8-16 barres verticales animées
   - Animation fluide 60fps
   - Design cohérent avec thème (glassmorphism)

4. **AC4 - Visualisation fréquences**
   - AnalyserNode récupère données fréquences (60fps)
   - Calcul amplitudes par bande de fréquences
   - Mise à jour barres en temps réel

5. **AC5 - Gestion erreurs**
   - Autoplay blocked : bouton play visible, pas d'autoplay
   - Format non supporté : message erreur discret
   - Erreur chargement : message erreur, désactiver audio
   - Performance : désactiver visualiseur si performance OK, garder audio

## Impacts

### Fichiers/Modules à créer
- `src/services/audioService.js` - Service gestion audio
- `src/components/Taskbar/AudioPlayer.jsx` - Composant contrôle audio
- `src/components/Taskbar/AudioVisualizer.jsx` - Composant visualiseur
- `src/hooks/useAudio.js` - Hook audio (optionnel, ou service direct)

### Fichiers à modifier
- `src/components/Taskbar/Taskbar.jsx` - Intégrer AudioPlayer, AudioVisualizer
- `src/components/Taskbar/Taskbar.module.css` - Styles audio components
- `public/` - Ajouter fichier audio (MP3/OGG)

### Endpoints
**Aucun**

### Base de données
**Aucune**

### Dépendances npm
**Aucune nouvelle** - Web Audio API natif

### Fichier audio requis
- Fichier musique d'ambiance (MP3 ou OGG)
- Placer dans `public/audio/` ou `public/`
- Format libre de droits ou fourni par utilisateur

## Tasks / Subtasks

- [ ] **Task 1: Service AudioService** (AC: 1)
  - [ ] Créer `src/services/audioService.js`
  - [ ] Initialiser AudioContext (lazy, après interaction utilisateur)
  - [ ] Créer AnalyserNode
  - [ ] Fonctions : play(), pause(), setVolume(), getFrequencyData()
  - [ ] Gérer état : isPlaying, volume, audioContext, analyserNode

- [ ] **Task 2: Composant AudioPlayer** (AC: 2)
  - [ ] Créer `src/components/Taskbar/AudioPlayer.jsx`
  - [ ] Bouton play/pause
  - [ ] Contrôle volume (slider ou boutons +/-)
  - [ ] Intégrer AudioService
  - [ ] Gérer autoplay policy (pas d'autoplay, bouton play manuel)

- [ ] **Task 3: Composant AudioVisualizer** (AC: 3, 4)
  - [ ] Créer `src/components/Taskbar/AudioVisualizer.jsx`
  - [ ] Créer 8-16 barres verticales (divs ou canvas)
  - [ ] Utiliser AnalyserNode pour récupérer fréquences
  - [ ] Animation requestAnimationFrame (60fps)
  - [ ] Calcul amplitudes par bande
  - [ ] Mise à jour hauteur barres selon amplitudes

- [ ] **Task 4: Intégration Taskbar** (AC: 2, 3)
  - [ ] Modifier `src/components/Taskbar/Taskbar.jsx`
  - [ ] Intégrer AudioPlayer (à côté horloge)
  - [ ] Intégrer AudioVisualizer (barres animées)
  - [ ] Style cohérent avec taskbar

- [ ] **Task 5: Chargement fichier audio** (AC: 1, 5)
  - [ ] Ajouter fichier audio dans `public/audio/`
  - [ ] Charger audio dans AudioService (new Audio() ou AudioContext)
  - [ ] Gérer erreurs chargement (format non supporté, 404)
  - [ ] Gérer autoplay blocked (politique navigateurs)

- [ ] **Task 6: Gestion erreurs** (AC: 5)
  - [ ] Try/catch autour AudioContext, chargement audio
  - [ ] Gérer autoplay blocked (bouton play visible)
  - [ ] Gérer format non supporté (message discret)
  - [ ] Gérer performance (désactiver visualiseur si lag, garder audio)

- [ ] **Task 7: Tests** (AC: 2, 3, 4)
  - [ ] Test play/pause fonctionne
  - [ ] Test volume fonctionne
  - [ ] Test visualiseur affiche barres animées
  - [ ] Test gestion erreurs

## Dev Notes

### Architecture technique

**Source: design-solution-par-lot.md#Lot-5**

#### Modèle de données
```javascript
// État audio (dans AudioService ou Context)
{
  isPlaying: boolean,
  volume: number, // 0-1
  currentTrack: string | null,
  audioContext: AudioContext | null,
  analyserNode: AnalyserNode | null,
}
```

#### Web Audio API
```javascript
// Initialisation AudioContext (lazy, après interaction)
const audioContext = new (window.AudioContext || window.webkitAudioContext)();

// Créer AnalyserNode
const analyser = audioContext.createAnalyser();
analyser.fftSize = 256; // Taille FFT (puissance de 2)

// Récupérer données fréquences
const frequencyData = new Uint8Array(analyser.frequencyBinCount);
analyser.getByteFrequencyData(frequencyData);

// Calcul amplitudes par bande (pour 8-16 barres)
const barCount = 16;
const dataPerBar = Math.floor(frequencyData.length / barCount);
const amplitudes = [];
for (let i = 0; i < barCount; i++) {
  const start = i * dataPerBar;
  const end = start + dataPerBar;
  const sum = frequencyData.slice(start, end).reduce((a, b) => a + b, 0);
  amplitudes.push(sum / dataPerBar / 255); // Normaliser 0-1
}
```

#### Visualisation barres
```javascript
// Animation requestAnimationFrame
useEffect(() => {
  let animationId;
  
  const animate = () => {
    // Récupérer données fréquences
    const amplitudes = audioService.getFrequencyData();
    
    // Mettre à jour hauteur barres
    bars.forEach((bar, i) => {
      const height = amplitudes[i] * 100; // 0-100%
      bar.style.height = `${height}%`;
    });
    
    animationId = requestAnimationFrame(animate);
  };
  
  animate();
  
  return () => cancelAnimationFrame(animationId);
}, [isPlaying]);
```

#### Autoplay Policy
Les navigateurs modernes bloquent l'autoplay audio. Solution :
- Ne pas autoplay au chargement
- Bouton play manuel (première interaction utilisateur)
- Initialiser AudioContext après clic utilisateur

### Patterns existants

**Source: etat-des-lieux.md#Patterns-existants**

- **Services**: Créer service dans `src/services/` (nouveau pattern)
- **CSS Modules**: Utiliser `.module.css`
- **State Management**: Service singleton ou hook useAudio

### Gestion d'erreurs

**Source: design-solution-par-lot.md#Lot-5**

- **Audio Load Error**: Afficher message erreur discret, désactiver audio
- **Autoplay Blocked**: Ne pas autoplay, bouton play manuel
- **Format Not Supported**: Fallback vers autre format ou message erreur
- **Performance**: Si performance dégradée → désactiver visualiseur, garder audio

### Fichier audio

- Format : MP3 (compatibilité large) ou OGG (open source)
- Taille : Optimiser (compression) pour éviter bundle lourd
- Droits : Libre de droits ou fourni par utilisateur

### Risques identifiés

1. **Autoplay blocked** (Impact: Faible, Probabilité: Élevée)
   - **Mitigation**: Bouton play manuel, pas d'autoplay
   - **Rollback**: N/A (comportement attendu)

2. **Fichier audio lourd** (Impact: Moyen, Probabilité: Faible)
   - **Mitigation**: Optimiser taille, lazy loading
   - **Rollback**: Réduire qualité audio, ou désactiver audio

3. **Performance visualiseur** (Impact: Faible, Probabilité: Faible)
   - **Mitigation**: Optimiser calculs, limiter barres
   - **Rollback**: Désactiver visualiseur, garder audio uniquement

### Plan de rollback

1. **Rollback immédiat**: Désactiver AudioPlayer dans Taskbar (commenter)
2. **Rollback partiel**: Garder audio mais sans visualiseur
3. **Rollback complet**: Supprimer composants, restaurer Taskbar.jsx original

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Story créée | Bob (SM) |

## Dev Agent Record
_TBD_

## QA Results
_TBD_
