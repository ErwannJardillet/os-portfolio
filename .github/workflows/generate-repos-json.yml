- name: Generate repos.json from GitHub API
  env:
    GH_TOKEN: ${{ secrets.GH_TOKEN }}
    USERNAME: ${{ github.repository_owner }}
  run: |
    set -euo pipefail
    mkdir -p public

    echo "Generating public/repos.json for USERNAME=$USERNAME"
    curl -sS \
      -H "Authorization: Bearer $GH_TOKEN" \
      -H "Accept: application/vnd.github+json" \
      "https://api.github.com/users/$USERNAME/repos?per_page=100&sort=updated" \
    | jq '[ .[]
            | select(.fork == false)
            | {
                name: .name,
                description: .description,
                url: .html_url,
                homepage: .homepage,
                stars: .stargazers_count,
                language: .language,
                topics: (.topics // []),
                updated: .updated_at
              } ]' > public/repos.json

    echo "----- public/ content -----"
    ls -la public
    echo "----- repos.json preview -----"
    head -c 500 public/repos.json || true
    echo

- name: Commit changes (if any)
  run: |
    set -euo pipefail
    git status
    git diff --stat || true

    if git diff --quiet; then
      echo "No changes"
      exit 0
    fi

    git config user.name "github-actions[bot]"
    git config user.email "github-actions[bot]@users.noreply.github.com"

    # Si jamais repos.json est ignor√© par .gitignore, ceci le force
    git add -f public/repos.json

    git commit -m "chore: update repos.json"
    git push
